{% extends "base.html" %}
{% load humanize %}
{% load marketing_icons %}
{% load static %}

{% block extra_head %}
  {{ block.super }}
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="{% static 'js/vehicle-detail.js' %}"></script>
{% endblock %}

{% block title %}{{ meta.title }}{% endblock %}
{% block meta_description %}{{ meta.description }}{% endblock %}

{% block content %}
<section class="bg-white/95 py-8 border-b border-todde-jet/10">
  <div class="container flex flex-wrap items-center justify-between gap-4">
    <div>
      <nav aria-label="Breadcrumb" class="text-xs text-todde-dark/60">
        <ol class="flex items-center gap-2">
          <li><a href="/" class="hover:text-todde-blue">Home</a></li>
          <li>/</li>
          <li><a href="/cars/" class="hover:text-todde-blue">All Cars</a></li>
          <li>/</li>
          <li class="text-todde-dark">{{ variant.model.manufacturer.name }} {{ variant.model.name }} {{ variant.year }}</li>
        </ol>
      </nav>
      <h1 class="mt-3 text-3xl font-semibold text-todde-dark">{{ variant.model.manufacturer.name }} {{ variant.model.name }} {{ variant.year }} {{ variant.trim }}</h1>
      {% if detail and detail.subheadline %}
      <p class="mt-2 max-w-2xl text-sm text-todde-dark/70">{{ detail.subheadline }}</p>
      {% endif %}
    </div>
    <div class="flex items-center gap-3 rounded-full border border-todde-jet/10 bg-white px-5 py-2 text-sm font-medium text-todde-dark/70">
      <span class="text-todde-blue">Stock #{{ variant.id }}</span>
    </div>
  </div>
</section>

<section class="py-12">
  <div class="container grid gap-10 lg:grid-cols-[248px,_minmax(0,_1fr),_360px] xl:grid-cols-[260px,_minmax(0,_1fr),_380px]">
    <aside class="order-2 space-y-6 lg:order-1">
      <div class="rounded-3xl border border-todde-jet/10 bg-white p-6 shadow-subtle">
        <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-todde-dark/50">Categories</h3>
        <ul class="mt-4 space-y-3 text-sm text-todde-dark/80">
          {% for category in categories %}
          <li><a href="{{ category.url }}" class="flex items-center justify-between hover:text-todde-blue"><span>{{ category.label }}</span><span class="text-[11px] text-todde-dark/40">›</span></a></li>
          {% endfor %}
        </ul>
      </div>

      <div class="rounded-3xl border border-todde-jet/10 bg-white p-6 shadow-subtle">
        <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-todde-dark/50">Manufacturers</h3>
        <ul class="mt-4 space-y-3 text-sm text-todde-dark/80">
          {% for manufacturer in manufacturers %}
          <li><a href="/cars/?manufacturer={{ manufacturer.slug }}" class="hover:text-todde-blue">{{ manufacturer.name }}</a></li>
          {% endfor %}
        </ul>
      </div>

      {% if recent_variants %}
      <div class="rounded-3xl border border-todde-jet/10 bg-white p-6 shadow-subtle">
        <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-todde-dark/50">Recently Viewed</h3>
        <ul class="mt-4 space-y-3 text-sm text-todde-dark/80">
          {% for recent in recent_variants %}
          <li>
            <a href="{% url 'marketing:vehicle_detail' recent.id %}" class="flex flex-col gap-1 hover:text-todde-blue">
              <span class="font-medium">{{ recent.model.manufacturer.name }} {{ recent.model.name }}</span>
              <span class="text-xs text-todde-dark/40">Mileage • {{ recent.year }}</span>
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </aside>

    <div class="order-1 flex flex-col gap-10 lg:order-2">
      <div class="space-y-6">
        <div class="relative vehicle-gallery-frame shadow-card" data-vehicle-gallery>
          {% if primary_gallery_image %}
          <figure>
            <img
              src="{{ primary_gallery_image.source_url }}"
              alt="{{ primary_gallery_image.alt_text|default:variant }}"
              class="h-[420px] w-full object-cover md:h-[460px]"
              data-gallery-image
              data-initial-src="{{ primary_gallery_image.source_url }}"
              data-initial-alt="{{ primary_gallery_image.alt_text|default:variant }}"
            />
          </figure>
          {% endif %}
          <div class="absolute right-6 top-6 hidden gap-3 md:flex" role="group" aria-label="Vehicle gallery navigation">
            <button
              type="button"
              class="vehicle-gallery-nav-pill inline-flex h-10 w-10 items-center justify-center rounded-full text-lg font-semibold text-todde-dark shadow-subtle"
              data-gallery-prev
              aria-label="Previous image"
            >‹</button>
            <button
              type="button"
              class="vehicle-gallery-nav-pill inline-flex h-10 w-10 items-center justify-center rounded-full text-lg font-semibold text-todde-dark shadow-subtle"
              data-gallery-next
              aria-label="Next image"
            >›</button>
          </div>
        </div>
        {% if gallery_thumbnails %}
        <div class="grid grid-cols-3 gap-3 md:grid-cols-5">
          {% for image in gallery_thumbnails %}
          <a
            href="{{ image.source_url }}"
            class="vehicle-gallery-thumb group"
            data-gallery-thumb
            data-src="{{ image.source_url }}"
            data-alt="{{ image.alt_text|default:variant }}"
          >
            <img src="{{ image.source_url }}" alt="{{ image.alt_text|default:variant }}" class="h-24 w-full object-cover transition duration-300 group-hover:scale-105" />
          </a>
          {% endfor %}
        </div>
        {% endif %}
      </div>

      <section class="rounded-3xl border border-todde-jet/10 bg-white p-6 shadow-subtle">
        <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
          <div>
            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-todde-dark/50">Car ID: {{ variant.id }} • Year: {{ variant.year }}</p>
            <h2 class="mt-2 text-2xl font-semibold text-todde-dark lg:text-3xl">{{ variant.model.manufacturer.name }} {{ variant.model.name }}{% if variant.trim %} {{ variant.trim }}{% endif %}</h2>
            <p class="vehicle-price-accent">{{ variant.formatted_price }}</p>
            {% if detail and detail.finance_intro %}
            <p class="mt-2 text-sm text-todde-dark/60">{{ detail.finance_intro }}</p>
            {% endif %}
          </div>
          <div class="flex flex-wrap gap-3">
            <a href="/financing/" class="todde-button-accent">Car Financing</a>
            <a href="#" class="todde-button-outline">Next Friend</a>
            <a href="#" class="todde-button-secondary">Pay Outright</a>
          </div>
        </div>
        <dl class="mt-6 grid gap-4 text-sm text-todde-dark/70 sm:grid-cols-2 xl:grid-cols-4">
          <div class="vehicle-summary-stat">
            <dt class="text-xs font-semibold uppercase tracking-[0.2em] text-todde-dark/50">Location</dt>
            <dd class="mt-1 text-base font-semibold text-todde-dark">{{ detail.location|default:"Lagos, Nigeria" }}</dd>
          </div>
          <div class="vehicle-summary-stat">
            <dt class="text-xs font-semibold uppercase tracking-[0.2em] text-todde-dark/50">Mileage</dt>
            <dd class="mt-1 text-base font-semibold text-todde-dark">{{ detail.mileage_display }}</dd>
          </div>
          <div class="vehicle-summary-stat">
            <dt class="text-xs font-semibold uppercase tracking-[0.2em] text-todde-dark/50">Body</dt>
            <dd class="mt-1 text-base font-semibold text-todde-dark">{{ variant.model.get_body_type_display }}</dd>
          </div>
          <div class="vehicle-summary-stat">
            <dt class="text-xs font-semibold uppercase tracking-[0.2em] text-todde-dark/50">Transmission</dt>
            <dd class="mt-1 text-base font-semibold text-todde-dark">{{ variant.get_transmission_display }}</dd>
          </div>
        </dl>
      </section>

      <section class="grid gap-6 xl:grid-cols-[minmax(0,_3fr),_2fr]">
        <article class="rounded-3xl border border-todde-jet/10 bg-white p-6 shadow-subtle">
          <h2 class="text-lg font-semibold text-todde-dark">Description</h2>
          <p class="mt-3 text-sm leading-relaxed text-todde-dark/80">
            {% if detail and detail.description %}
              {{ detail.description }}
            {% else %}
              Experience premium comfort and power with this {{ variant.model.manufacturer.name }} {{ variant.model.name }}. Professionally inspected by Todde engineers and ready for same-week delivery.
            {% endif %}
          </p>
        </article>
        <article class="rounded-3xl border border-todde-jet/10 bg-white p-6 shadow-subtle">
          <h2 class="text-lg font-semibold text-todde-dark">Specifications</h2>
          <dl class="mt-5 grid gap-4">
            {% for spec in specifications %}
            <div class="flex items-center justify-between gap-4 border-b border-dashed border-todde-jet/10 pb-3 last:border-b-0 last:pb-0">
              <dt class="text-xs font-semibold uppercase tracking-[0.25em] text-todde-dark/50">{{ spec.label }}</dt>
              <dd class="text-sm font-medium text-todde-dark text-right">{{ spec.value }}</dd>
            </div>
            {% endfor %}
          </dl>
        </article>
      </section>

      {% if related_variants %}
      <section>
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-semibold text-todde-dark">You might also like</h2>
          <a href="/cars/" class="text-sm font-semibold text-todde-blue hover:text-todde-blue-dark">View all inventory →</a>
        </div>
        <div class="mt-6 grid gap-6 sm:grid-cols-2 xl:grid-cols-3">
          {% for item in related_variants %}
          <article class="flex flex-col overflow-hidden rounded-3xl border border-white/40 bg-white shadow-lg">
            <a href="{% url 'marketing:vehicle_detail' item.id %}" class="relative h-40 w-full overflow-hidden">
              <img src="https://images.unsplash.com/photo-1511919884226-fd3cad34687c?auto=format&fit=crop&w=800&q=80" alt="{{ item.model.manufacturer.name }} {{ item.model.name }}" class="h-full w-full object-cover" />
              <span class="absolute inset-x-4 top-4 inline-flex items-center rounded-full bg-white/90 px-3 py-1 text-xs font-semibold uppercase tracking-wider text-todde-blue">{{ item.model.manufacturer.name }}</span>
            </a>
            <div class="flex flex-1 flex-col gap-3 p-5">
              <h3 class="text-base font-semibold text-todde-dark">
                <a href="{% url 'marketing:vehicle_detail' item.id %}" class="hover:text-todde-blue">
                  {{ item.model.manufacturer.name }} {{ item.model.name }} {{ item.year }}
                </a>
              </h3>
              <p class="text-sm text-todde-dark/60">{{ item.model.get_body_type_display }} • {{ item.get_transmission_display }}</p>
              <p class="mt-auto text-lg font-semibold text-todde-blue">{{ item.formatted_price }}</p>
            </div>
          </article>
          {% endfor %}
        </div>
      </section>
      {% endif %}
    </div>

    <aside class="order-3 space-y-6 lg:order-3">
      <section class="vehicle-highlight-card">
        <p class="vehicle-highlight-eyebrow">Why you'll love it</p>
        <h2 class="vehicle-highlight-title">{{ detail.headline|default:"Key highlights for this model" }}</h2>
        {% if detail and detail.subheadline %}
        <p class="vehicle-highlight-subhead">{{ detail.subheadline }}</p>
        {% endif %}
        <h3 class="vehicle-highlight-subtitle">Key Features</h3>
        <ul class="vehicle-highlight-list">
          {% for feature in features %}
          <li class="vehicle-highlight-item">
            {% marketing_icon 'heroicons:check' 'mt-0.5 h-5 w-5 vehicle-highlight-icon' %}
            <span>{{ feature.text }}</span>
          </li>
          {% empty %}
          <li class="vehicle-highlight-empty">Details coming soon.</li>
          {% endfor %}
        </ul>
      </section>

      <section class="rounded-3xl border border-todde-jet/10 bg-white p-0 shadow-subtle md:sticky md:top-28" data-loan-tabs>
        <div class="loan-tablist" role="tablist" aria-label="Financing options">
          <button
            type="button"
            id="loan-tab-finance"
            class="loan-tab-trigger loan-tab-trigger--active"
            data-loan-tab="finance"
            role="tab"
            aria-selected="true"
            aria-controls="loan-panel-finance"
            tabindex="0"
          >
            Car Financing
          </button>
          <button
            type="button"
            id="loan-tab-refer"
            class="loan-tab-trigger"
            data-loan-tab="refer"
            role="tab"
            aria-selected="false"
            aria-controls="loan-panel-refer"
            tabindex="-1"
          >
            Refer Friend
          </button>
          <button
            type="button"
            id="loan-tab-payout"
            class="loan-tab-trigger"
            data-loan-tab="payout"
            role="tab"
            aria-selected="false"
            aria-controls="loan-panel-payout"
            tabindex="-1"
          >
            Pay Outright
          </button>
        </div>
        <div class="loan-tab-content">
          <div
            data-loan-panel="finance"
            id="loan-panel-finance"
            class="loan-tab-panel"
            role="tabpanel"
            aria-labelledby="loan-tab-finance"
          >
            <h2 class="text-lg font-semibold text-todde-dark">Loan Calculator</h2>
            <p class="mt-1 text-xs text-todde-dark/60">Adjust the sliders to estimate repayments with Todde partner financing.</p>
            <form
              id="loan-calculator"
              class="mt-8 space-y-6"
              data-price="{{ variant.price }}"
              data-currency="{{ variant.currency }}"
              data-default-deposit="{{ loan_summary.deposit_percent }}"
              data-default-rate="{{ loan_summary.rate_percent }}"
              data-default-period="{{ loan_summary.period_months }}"
            >
              <div class="loan-calculator-layout space-y-6">
                <div class="loan-controls w-full space-y-6">
                  <div class="space-y-3 rounded-2xl border border-todde-jet/10 bg-white/80 p-5 shadow-sm">
                    <div class="flex items-center justify-between">
                      <label for="loan-deposit-percent" class="text-xs font-semibold uppercase tracking-[0.25em] text-todde-dark/60">Deposit (%)</label>
                      <span class="text-xs font-semibold text-todde-dark/60">{{ loan_summary.deposit_percent }}% default</span>
                    </div>
                    <div class="grid gap-3 sm:grid-cols-[96px,_1fr] sm:items-center">
                      <input
                        id="loan-deposit-percent"
                        name="deposit_percent"
                        type="number"
                        min="10"
                        max="80"
                        step="1"
                        value="{{ loan_summary.deposit_percent }}"
                        class="w-full rounded-lg border border-todde-jet/20 bg-white px-3 py-2 text-sm text-todde-dark"
                      />
                      <input
                        id="loan-deposit-range"
                        type="range"
                        min="10"
                        max="80"
                        step="1"
                        value="{{ loan_summary.deposit_percent }}"
                        class="w-full accent-todde-blue"
                        aria-labelledby="loan-deposit-percent"
                      />
                    </div>
                    <p class="text-xs text-todde-dark/60">Estimated deposit: <span id="loan-deposit-amount" class="font-semibold text-todde-dark"></span></p>
                  </div>

                  <div class="space-y-3 rounded-2xl border border-todde-jet/10 bg-white/80 p-5 shadow-sm">
                    <label for="loan-period" class="text-xs font-semibold uppercase tracking-[0.25em] text-todde-dark/60">Tenor (months)</label>
                    <input
                      id="loan-period"
                      name="period_months"
                      type="number"
                      min="12"
                      max="48"
                      step="6"
                      value="{{ loan_summary.period_months }}"
                      class="w-full rounded-lg border border-todde-jet/20 bg-white px-3 py-2 text-sm text-todde-dark"
                    />
                    <p class="text-xs text-todde-dark/60">Flex financing between 12 and 48 months. Longer tenors lower your monthly repayment.</p>
                  </div>

                  <div class="space-y-2 rounded-2xl border border-todde-jet/10 bg-todde-neutral/70 p-5 text-xs text-todde-dark/70 shadow-sm">
                    <p class="font-semibold uppercase tracking-[0.3em] text-todde-dark/60">Todde Partner Rate</p>
                    <p>Repayments are estimated at an annual rate of <strong>{{ loan_summary.rate_percent }}%</strong>. Final offers depend on credit review, documentation, and Todde partner bank underwriting.</p>
                  </div>
                </div>

                <div class="loan-side-panel w-full rounded-2xl border border-todde-jet/10 bg-white/90 p-5 shadow-sm">
                  <div>
                    <p class="text-xs font-semibold uppercase tracking-[0.3em] text-todde-dark/50">Your financing snapshot</p>
                    <p class="mt-1 text-sm text-todde-dark/60">Update the fields to see how your deposit and tenor influence repayments.</p>
                  </div>
                  <dl class="space-y-4 text-sm text-todde-dark">
                    <div class="loan-metric-row border-b border-dashed border-todde-jet/15 pb-4 last:border-0 last:pb-0">
                      <dt class="loan-metric-label text-xs font-semibold text-todde-dark/50">Vehicle Price</dt>
                      <dd id="loan-price" class="loan-metric-value text-base font-semibold">{{ variant.formatted_price }}</dd>
                    </div>
                    <div class="loan-metric-row border-b border-dashed border-todde-jet/15 pb-4 last:border-0 last:pb-0">
                      <dt class="loan-metric-label text-xs font-semibold text-todde-dark/50">Deposit Amount</dt>
                      <dd id="loan-deposit" class="loan-metric-value text-base font-semibold"></dd>
                    </div>
                    <div class="loan-metric-row border-b border-dashed border-todde-jet/15 pb-4 last:border-0 last:pb-0">
                      <dt class="loan-metric-label text-xs font-semibold text-todde-dark/50">Loan Amount</dt>
                      <dd id="loan-amount" class="loan-metric-value text-base font-semibold"></dd>
                    </div>
                    <div class="loan-metric-row">
                      <dt class="loan-metric-label text-xs font-semibold text-todde-dark/50">Monthly Repayment</dt>
                      <dd id="loan-monthly" class="loan-metric-value text-2xl font-semibold text-todde-blue"></dd>
                    </div>
                  </dl>
                </div>
              </div>

              <p id="loan-calculator-feedback" class="hidden text-xs font-medium text-red-600"></p>

              <button type="button" class="todde-button-primary w-full justify-center">Apply for Loan</button>
            </form>
          </div>

          <div
            data-loan-panel="refer"
            id="loan-panel-refer"
            class="loan-tab-panel"
            role="tabpanel"
            aria-labelledby="loan-tab-refer"
            hidden
          >
            <div class="space-y-4">
              <h2 class="text-lg font-semibold text-todde-dark">Refer a friend</h2>
              <p class="text-sm text-todde-dark/70">Invite a friend to Todde and earn referral bonuses when they complete financing. Share your unique link from the Todde Partner app or speak with our advisors to get started.</p>
              <ul class="list-disc space-y-2 pl-5 text-sm text-todde-dark/70">
                <li>Earn cash rewards on successful referrals.</li>
                <li>Track referral status inside the Todde dashboard.</li>
                <li>Access exclusive partner perks and quarterly draws.</li>
              </ul>
              <a href="mailto:partners@todde.africa" class="todde-button-outline inline-flex justify-center">Request referral link</a>
            </div>
          </div>

          <div
            data-loan-panel="payout"
            id="loan-panel-payout"
            class="loan-tab-panel"
            role="tabpanel"
            aria-labelledby="loan-tab-payout"
            hidden
          >
            <div class="space-y-4">
              <h2 class="text-lg font-semibold text-todde-dark">Pay outright</h2>
              <p class="text-sm text-todde-dark/70">Prefer to pay fully upfront? Our concierge team will guide you through inspection, documentation, and delivery within 72 hours of payment confirmation.</p>
              <ul class="list-disc space-y-2 pl-5 text-sm text-todde-dark/70">
                <li>Secure escrow-backed transactions.</li>
                <li>Complimentary inspection and service history report.</li>
                <li>Doorstep delivery available in major Nigerian cities.</li>
              </ul>
              <a href="tel:+23417001234" class="todde-button-secondary inline-flex justify-center">Talk to sales</a>
            </div>
          </div>
        </div>
      </section>

      <section class="rounded-3xl border border-todde-jet/10 bg-white p-6 shadow-subtle">
        <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-todde-dark/50">Applicant Types</h3>
        <ul class="mt-4 space-y-2 text-sm text-todde-dark/80">
          {% for applicant in applicant_types %}
          <li class="flex items-center gap-2">
            {% marketing_icon 'heroicons:user-circle' 'h-5 w-5 text-todde-blue' %}
            <span>{{ applicant }}</span>
          </li>
          {% endfor %}
        </ul>
      </section>
    </aside>
  </div>
</section>
{% endblock %}
